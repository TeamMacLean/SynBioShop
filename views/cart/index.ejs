<%- include('../head.ejs') %>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // ============================================================================
    // CONFIGURATION FROM SERVER
    // ============================================================================
    const CONFIG = {
      displayPricing: <%- JSON.stringify(displayPricing) %>,
      adminForceShowPricing: <%- JSON.stringify(adminForceShowPricing) %>,
      isAdmin: <%- JSON.stringify(isAdmin) %>,
      pricePerUnit: parseFloat('<%= pricePerUnit %>')
    };

    // ============================================================================
    // DOM ELEMENTS
    // ============================================================================
    const elements = {
      navCartCount: document.querySelector('.nav-cart .count'),
      totalQuantity: document.getElementById('totalQuantity'),
      totalQuantityInput: document.getElementById('totalQuantity-input'),
      totalCost: document.getElementById('totalCost'),
      totalCostInput: document.getElementById('totalCost-input'),
      orderForm: document.getElementById('orderForm'),
      signatorySelect: document.getElementById('signatory'),
      costConsentCheckbox: document.getElementById('cost-consent'),
      nonCommercialConsentCheckbox: document.getElementById('non-commerical-consent')
    };

    // ============================================================================
    // CART CALCULATIONS
    // ============================================================================

    /**
     * Calculate and update cart totals
     * Updates both display and hidden form inputs
     */
    function updateTotals() {
      const quantityElements = document.querySelectorAll('.item-quantity');
      let totalQuantity = 0;
      let totalCost = 0;

      quantityElements.forEach((element) => {
        const quantity = parseInt(element.value || element.textContent, 10) || 0;
        totalQuantity += quantity;

        // Update individual item price if pricing is displayed
        if (CONFIG.displayPricing) {
          const parentRow = element.closest('tr');
          if (parentRow) {
            const priceEl = parentRow.querySelector('[id^="price_"]');
            if (priceEl) {
              priceEl.textContent = (quantity * CONFIG.pricePerUnit).toFixed(2);
            }
          }
          totalCost += quantity * CONFIG.pricePerUnit;
        }
      });

      // Update total quantity display
      if (elements.totalQuantity && elements.totalQuantityInput) {
        elements.totalQuantity.textContent = totalQuantity;
        elements.totalQuantityInput.value = totalQuantity;
      }

      // Update total cost display if applicable
      if (CONFIG.displayPricing && elements.totalCost && elements.totalCostInput) {
        elements.totalCost.textContent = totalCost.toFixed(2);
        elements.totalCostInput.value = totalCost.toFixed(2);
      }
    }

    /**
     * Validate and constrain quantity input
     */
    function constrainQuantity(inputElement) {
      let value = parseInt(inputElement.value, 10) || 1;

      // Enforce minimum of 1
      if (value < 1) {
        value = 1;
      }

      // For TSL users (no pricing), enforce maximum of 1
      if (!CONFIG.displayPricing && value > 1) {
        value = 1;
      }

      // Enforce maximum of 25
      if (value > 25) {
        value = 25;
      }

      inputElement.value = value;
      updateTotals();
    }

    // ============================================================================
    // EVENT HANDLERS
    // ============================================================================

    /**
     * Setup quantity input event listeners
     */
    document.querySelectorAll('input.item-quantity').forEach((inputElement) => {
      inputElement.addEventListener('keyup', () => constrainQuantity(inputElement));
      inputElement.addEventListener('change', () => constrainQuantity(inputElement));
      inputElement.addEventListener('blur', () => constrainQuantity(inputElement));
    });

    /**
     * Handle item removal from cart
     */
    $('body').on('click', 'a[name="removeItem"].areyousure', function(e) {
      e.preventDefault();
      const itemId = $(this).data('id');

      if (typeof socket !== 'undefined') {
        socket.emit('removeFromCart', { id: itemId });
      } else {
        console.warn('Socket.IO not available. Reloading page.');
        location.reload();
      }
    });

    // ============================================================================
    // SOCKET.IO INTEGRATION
    // ============================================================================

    if (typeof socket !== 'undefined') {
      /**
       * Handle item removed from cart
       */
      socket.on('removedFromCart', function (data) {
        const row = document.querySelector('tr[data-id="' + data.id + '"]');
        if (row) {
          $(row).fadeOut(500, function () {
            this.remove();

            // Update nav cart count
            const currentCount = parseInt(elements.navCartCount.textContent, 10) || 0;
            elements.navCartCount.textContent = Math.max(0, currentCount - 1);

            // Check if cart is now empty
            const remainingItems = document.querySelectorAll('.item-quantity');
            if (remainingItems.length === 0) {
              location.reload();
            } else {
              updateTotals();
            }
          });
        }
      });

      /**
       * Handle quantity changes via socket
       */
      $('input.item-quantity[name="itemQuantity"]').on('change keyup paste', function (e) {
        let val = parseInt($(this).val(), 10) || 1;
        val = Math.min(Math.max(val, 1), 25);
        $(this).val(val);

        socket.emit('changeQuantity', {
          id: $(this).data('id'),
          quantity: val
        });
      });

      /**
       * Handle quantity updated from server
       */
      socket.on('quantityUpdated', function (data) {
        const quantityElement = document.getElementById('quantity_' + data.id);

        if (quantityElement) {
          if (quantityElement.tagName === 'INPUT') {
            quantityElement.value = data.quantity;
            quantityElement.dispatchEvent(new Event('change'));
          } else if (quantityElement.tagName === 'SPAN') {
            quantityElement.textContent = data.quantity;
            updateTotals();
          }
        }
      });
    } else {
      console.warn('Socket.IO not available. Real-time updates disabled.');
    }

    // ============================================================================
    // FORM VALIDATION
    // ============================================================================

    if (elements.orderForm) {
      elements.orderForm.addEventListener('submit', function (event) {
        event.preventDefault();

        // Validate budget holder selection if pricing is displayed
        if (CONFIG.displayPricing) {
          if (!elements.signatorySelect || elements.signatorySelect.value === '') {
            alert('Please select a budget holder.');
            return;
          }
        }

        // Validate consent checkboxes
        if (elements.costConsentCheckbox && !elements.costConsentCheckbox.checked) {
          alert('You must confirm you have authority to spend.');
          return;
        }

        if (elements.nonCommercialConsentCheckbox && !elements.nonCommercialConsentCheckbox.checked) {
          alert('You must confirm the materials will be used for non-commercial purposes only.');
          return;
        }

        // Validate cart not empty
        const allItemQuantities = document.querySelectorAll('.item-quantity');
        if (allItemQuantities.length === 0) {
          alert('Your cart is empty. Please add items before placing an order.');
          return;
        }

        // Validate all item quantities are valid
        for (let i = 0; i < allItemQuantities.length; i++) {
          const element = allItemQuantities[i];
          const quantity = parseInt(element.value || element.textContent, 10) || 0;

          if (isNaN(quantity) || quantity < 1) {
            alert('Item at row ' + (i + 1) + ' has an invalid quantity. Please ensure all quantities are 1 or more.');
            if (element.tagName === 'INPUT') {
              element.focus();
            }
            return;
          }
        }

        // All validations passed - submit form
        elements.orderForm.submit();
      });
    }

    // ============================================================================
    // INITIALIZATION
    // ============================================================================

    // Calculate initial totals on page load
    updateTotals();
  });
</script>

<div class="container">
  <h1 class="center">Shopping Basket</h1>

  <!-- ========================================================================== -->
  <!-- SUCCESS MESSAGE -->
  <!-- ========================================================================== -->
  <% if (typeof orderId !== 'undefined' && orderId && orderJanCode) { %>
    <div class="flash-messages flash-success">
      Your order #<%= orderJanCode %> has been successfully placed!
    </div>
  <% } %>

  <!-- ========================================================================== -->
  <!-- CART CONTENTS -->
  <!-- ========================================================================== -->
  <% if (typeof cart !== 'undefined' && cart.items && cart.items.length > 0) { %>

    <!-- Admin Force Show Pricing Toggle -->
    <% if (isAdmin) { %>
      <div style="margin-bottom: 2rem;">
        <a
          href="<%- adminForceShowPricing ? '/cart' : '/cart?adminForceShowPricing=true' %>"
          class="btn btn-link"
        >
          <%- adminForceShowPricing ? 'Switch to Default View (Hide Pricing)' : 'Force Show Pricing' %>
          (Admin-only feature)
        </a>
      </div>
    <% } %>

    <!-- Information Messages -->
    <div class="form-group">
      <i>Order your items. A standard order item is 5μL.</i>
    </div>

    <% if (displayPricing) { %>
      <div class="form-group">
        <i>For non-TSL staff, pricing is currently set at £<%= Number(pricePerUnit).toFixed(2) %> per item. Bespoke orders available through email request.</i>
      </div>
    <% } %>

    <!-- ======================================================================== -->
    <!-- ORDER FORM -->
    <!-- ======================================================================== -->
    <form id="orderForm" method="post" action="/cart/order">
      <input type="hidden" name="pricePerUnit" value="<%= pricePerUnit %>" />

      <!-- Cart Items Table -->
      <table class="cart">
        <thead>
          <tr>
            <th>Item</th>
            <th class="center">Quantity</th>
            <% if (displayPricing) { %>
              <th class="center">Price</th>
            <% } %>
            <th class="center">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% cart.items.forEach(function(item, index) { %>
            <% const itemQuantity = item.quantity || 1; %>
            <tr data-id="<%- item.id %>">
              <!-- Item Name -->
              <td data-th="Item">
                <a href="/premade/item/<%- item.type.id %>"><%- item.type.name %></a>
              </td>

              <!-- Quantity -->
              <td data-th="Quantity" class="center">
                <span class="item-quantity" id="quantity_<%= index %>" data-id="<%- item.id %>">
                  <%= itemQuantity %>
                </span>
                <input type="hidden" name="itemQuantity" value="<%= itemQuantity %>" />
              </td>

              <!-- Price (if applicable) -->
              <% if (displayPricing) { %>
                <td data-th="Price" class="center">
                  £<span id="price_<%= index %>"><%= (itemQuantity * pricePerUnit).toFixed(2) %></span>
                </td>
              <% } %>

              <!-- Actions -->
              <td data-th="Actions" class="center">
                <a href="#"
                   name="removeItem"
                   class="button danger outline icon areyousure"
                   data-id="<%- item.id %>"
                   title="Remove item from cart">
                  <span data-icon="&#xe019;"></span>
                </a>
              </td>
            </tr>
          <% }); %>
        </tbody>

        <!-- Totals Footer -->
        <tfoot>
          <tr>
            <td><b>TOTAL</b></td>
            <td class="center">
              <b>
                <input type="hidden" id="totalQuantity-input" name="totalQuantity" />
                <span id="totalQuantity">0</span>
              </b>
            </td>
            <% if (displayPricing) { %>
              <td class="center">
                <b>
                  £<input type="hidden" id="totalCost-input" name="totalCost" />
                  <span id="totalCost">0.00</span>
                </b>
              </td>
            <% } %>
            <td></td>
          </tr>
        </tfoot>
      </table>

      <!-- ====================================================================== -->
      <!-- PAYMENT INFORMATION (for non-TSL users) -->
      <!-- ====================================================================== -->
      <% if (displayPricing) { %>
        <div class="form-group">
          <label for="costCode" class="form-label">Cost centre for charging:</label>
          <input
            id="costCode"
            name="costCode"
            type="text"
            minlength="11"
            maxlength="11"
            data-inputmask="'mask': '*****-***-*'"
            class="uppercase"
            placeholder="12345-678-9"
            required
          />
        </div>

        <div class="form-group">
          <label for="signatory" class="form-label">Select Budget Holder:</label>
          <select id="signatory" name="signatory" required>
            <option value="" disabled selected>Select budget holder</option>
            <% budgetHolders.forEach(function(holder) { %>
              <option value="<%= holder.value %>"><%= holder.label %></option>
            <% }); %>
          </select>
        </div>

        <div class="form-group">
          <input class="muted-text" id="cost-consent" type="checkbox" required>
          <label for="cost-consent" class="form-label muted-text">
            By ticking this box I am confirming that I have authority to spend on the above cost centre.
            I accept that my 'New Order' email generated from this submission will also be sent to the selected budget holder.
          </label>
        </div>
      <% } %>

      <!-- ====================================================================== -->
      <!-- NON-COMMERCIAL USE AGREEMENT -->
      <!-- ====================================================================== -->
      <div class="form-group">
        <p><i>
          TSL SynBio material supplied to TSL and JIC scientists is subject to a Material Transfer Agreement
          and must not be distributed or shared with any parties beyond TSL and JIC. Any third parties who
          request use of such material should be directed to TSL SynBio (please email
          <a href="mailto:Mark.Youles@tsl.ac.uk">Mark.Youles@tsl.ac.uk</a>).
        </i></p>
        <p><i>
          Material supplied by TSL SynBio is for non-commercial research purposes only. If you wish to use
          supplied material for commercial purposes, please contact
          <a href="mailto:Mark.Youles@tsl.ac.uk">Mark.Youles@tsl.ac.uk</a> in order that an appropriate
          MTA can be drawn up.
        </i></p>
        <input class="muted-text" id="non-commerical-consent" type="checkbox" required>
        <label for="non-commerical-consent" class="form-label muted-text">
          I have read the above and confirm that the materials on this order will be used for non-commercial
          research purposes only and will not be distributed to third parties.
        </label>
      </div>

      <!-- ====================================================================== -->
      <!-- SUBMIT BUTTON -->
      <!-- ====================================================================== -->
      <div class="row">
        <div class="col12">
          <div class="pull-right">
            <button class="button success areyousure" id="placeOrderButton" type="submit">
              Place Order
            </button>
          </div>
        </div>
      </div>
    </form>

  <% } else { %>
    <!-- ======================================================================== -->
    <!-- EMPTY CART MESSAGE -->
    <!-- ======================================================================== -->
    <h3 class="center">Your Shopping Basket is empty.</h3>
  <% } %>

</div>

<%- include('../foot.ejs') %>
