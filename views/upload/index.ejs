<%- include('../head.ejs') %>

<div class="container">

    <h1 class="center">File Manager</h1>
    <h5 class="center muted-text"><i>(<b>N.B.</b> This does not currently include sequence files.)</i></h5> <% /* Added muted-text for consistency */ %>
    <hr>

    <h2>Upload New File</h2>

    <form action="/upload" method="post" enctype="multipart/form-data" id="uploadForm">
        <div class="form-group">
            <label for="fileUploadInput" class="form-label">Select File:</label> <% /* Added label for accessibility */ %>
            <input type="file" name="file" id="fileUploadInput" required> <% /* Added id and required */ %>
        </div>
        <div class="form-group">
            <button class="button primary" type="submit" id="uploadButton" disabled>Upload File</button> <% /* Disabled by default */ %>
        </div>
    </form>
    <hr>

    <h2>Existing Files</h2>
    <p class="muted-text"><i>Sorted by upload date (newest first)</i></p>
    <div class="row ">
        <% if (files && files.length > 0) { %> <% /* Check if files exist */ %>
            <% files.forEach(function(file){ %> <% /* Changed map to forEach */ %>
            <div class="col4 auto-clear">
                <div class="tile">
                    <% if(file.isImage()){ %>
                    <img class="tile-img-top short" src="<%- file.downloadPath() %>" alt="Image for <%- file.originalName %>"> <% /* Added alt attribute */ %>
                    <% } else { %>
                    <div class="tile-img-top short">
                        <% /* Placeholder or icon for non-image files */ %>
                    </div>
                    <% } %>
                    <div class="tile-block">
                        <p><strong>Name:</strong> <%- file.originalName %></p> <% /* Added strong tag for label */ %>
                        <div class="form-group has-feedback">
                            <label for="file-path-<%- file.id %>" class="sr-only">File Path:</label> <% /* Screen reader only label */ %>
                            <input type="text" class="has-button" id="file-path-<%- file.id %>" value="<%- file.downloadPath() %>" readonly> <% /* Added readonly */ %>
                            <button class="inputbutton clipboard" data-clipboard-target="#file-path-<%- file.id %>" title="Copy to clipboard"> <% /* Added title for accessibility */ %>
                                <img src="/img/clippy.svg" alt="Copy to clipboard">
                            </button>
                        </div>
                        <% /* Convert DELETE <a> to POST form */ %>
                        <form action="/filemanager/<%- file.id %>/delete" method="POST" style="display:inline;">
                            <button type="submit" class="button danger areyousure">Delete File</button> <% /* Clarified button text */ %>
                        </form>
                    </div>
                </div>
            </div>
            <% }); %>
        <% } else { %>
            <p class="center muted-text">No general files uploaded yet.</p> <% /* Message for no files */ %>
        <% } %>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
    // Enable/disable upload button based on file selection
    var fileInput = document.getElementById('fileUploadInput');
    var uploadButton = document.getElementById('uploadButton');

    fileInput.addEventListener('change', function() {
        if (fileInput.files.length > 0) {
            uploadButton.disabled = false;
        } else {
            uploadButton.disabled = true;
        }
    });

    // Clipboard functionality
    var clipboard = new ClipboardJS('.clipboard');
    clipboard.on('success', function (e) {
        console.log('Text copied:', e.text);
        e.clearSelection();
        // Optional: Show a tooltip or notification
        var btn = e.trigger;
        var originalTitle = btn.getAttribute('title');
        btn.setAttribute('title', 'Copied!');
        setTimeout(function() {
            btn.setAttribute('title', originalTitle);
        }, 2000);
    });
    clipboard.on('error', function (e) {
        console.error('Failed to copy text:', e.action);
        alert('Failed to copy to clipboard. Please copy manually.');
    });
</script>

<%- include('../foot.ejs') %>
